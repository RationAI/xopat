<!DOCTYPE html>
<html lang="en" dir="ltr" data-light-theme="light">

<head>
    <meta charset="utf-8">
    <title>Visualization</title>
    <meta name="msapplication-TileColor" content="#da532c">
    <!--Necessary for OSD on phone portrait mode-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- TODO hardcoded path -->
    <link rel="apple-touch-icon" sizes="180x180" href="src/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="src/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="src/assets/favicon-16x16.png">
    <link rel="mask-icon" href="src/assets/safari-pinned-tab.svg" color="#5bbad5">

    <!--Remember WARNS/ERRORS to be able to export-->
    <script type="text/javascript">
        (function () {
            window.console.appTrace = [];

            const defaultError = console.error;
            const timestamp = () => {
                let ts = new Date(), pad = "000", ms = ts.getMilliseconds().toString();
                return ts.toLocaleTimeString("cs-CZ") + "." + pad.substring(0, pad.length - ms.length) + ms + " ";
            };
            window.console.error = function (...args) {
                window.console.appTrace.push("ERROR ",
                    // (new Error().stack.split("at ")[1]).trim(), " ",
                    timestamp(), ...args, "\n");

                const stack = new Error().stack;
                defaultError.apply(window.console, [...args, stack]);
            };

            const defaultWarn = console.warn;
            window.console.warn = function (...args) {
                window.console.appTrace.push("WARN  ", ...args, "\n");
                const stack = new Error().stack;
                defaultWarn.apply(window.console, [...args, stack]);
            };
        })();
    </script>

    <!-- Template head -->
    <template id="template-head"></template>
</head>
<body style="overflow: hidden; height: 100vh; width: 100vw">

    <!-- Template ui -->
    <template id="template-ui"></template>

<script>
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.setAttribute("data-theme", "catppuccin-mocha");
} else {
    document.body.removeAttribute("data-theme");
}
</script>
<!-- OSD viewer -->
<div id="viewer-container" class="position-absolute width-full height-full top-0 left-0" style="pointer-events: none;">
    <div id="osd" style="pointer-events: auto;" class="position-absolute width-full height-full top-0 left-0"></div>
    <div id='viewer-demo-advertising' style='display: none'>
        <h1>xOpat - The WSI Viewer</h1>
        <p>The viewer is missing the target data to view; this might happen, if</p>
        <ul class="ml-3">
            <li>you have an invalid link, or</li>
            <li>the server that should deliver data is not responding</li>
            <li>the data is not available due to authorization issues</li>
        </ul>
        <br><br>
        <p class="text-small mx-6 text-center">xOpat: a web based, NO-API oriented WSI Viewer with enhanced rendering of high resolution images overlaid, fully modular and customizable.</p>
        <img src="docs/assets/xopat-banner.png" style="width: 80%; display: block; margin: 0 auto;">
    </div>
</div>

<!-- System messaging -->
<div id="system-message" class="d-none system-container">
    <div id="system-message-warn" class="f00-light text-center">
        <span class="material-icons f0-light mr-1" style="transform: translate(0px, -5px);">error_outline</span>
        <span data-i18n="error.title">Error</span>
    </div>
    <div id="system-message-title" class="f2-light text-center clearfix"></div>
    <div id="system-message-subtitle" class="text-normal text-center"></div>
    <div class="text-small text-center mb-4" data-i18n="error.doExport"> [ if you want to report a problem, please include exported file ] </div>
    <button id="system-message-details-btn" onclick="$('#system-message-details').css('display', 'block'); $(this).css('display', 'none');" class="btn" type="button" data-i18n="error.detailsBtn">details</button>
    <div id="system-message-details" class="px-4 py-3 mb-2 border radius-3 overflow-y-scroll" style="display: none;max-height: 50vh;"></div>
    <button id="system-message-dismiss-btn" onclick="USER_INTERFACE.Errors.hide()" class="btn" type="button" data-i18n="error.dismissBtn">dismiss</button>
</div>

<!--Tutorials-->
<div id="tutorials-container" class="d-none system-container">
    <div id="tutorials-title" class="f1-light text-center clearfix"></div>
    <p id="tutorials-description" class="text-center"></p>
    <!--<p class="text-center">You can also show tutorial section by pressing 'H' on your keyboard.</p>-->
    <br>
    <div id="tutorials"></div>
    <br><br><button class="btn" onclick="USER_INTERFACE.Tutorials.hide();" data-i18n="common.Exit">Exit</button>
</div>

<!-- Main Panel -->
<div id="top-side" class="d-flex flex-row width-full" style="position: relative; background-color: gray; align-items: flex-start;">
    <div id="top-slide" class="" style="position: absolute; left: 50%; transform: translateX(-50%); top: 3px; bottom: auto;"></div>
    <div style="display: flex; flex-direction: row; justify-content: flex-end; width: 100%;">
        <div id = "top-plugins" style="margin-left: 5px; margin-right: 5px; margin-top: 3px; margin-bottom: 3px;"></div>
        <div id = "top-visual" style="margin-left: 5px; margin-right: 5px; margin-top: 3px; margin-bottom: 3px;"></div>
        <div id = "top-user" style="margin-left: 5px; margin-right: 5px; margin-top: 3px; margin-bottom: 3px;"></div>
        <div id = "top-fullscreen" style="margin-left: 5px; margin-right: 5px; margin-top: 3px; margin-bottom: 3px;"></div>
    </div>
</div>

<div id="left-side" class="d-flex flex-column height-full" style="position: fixed; width: 400px;">
</div>

<!-- TODO REMOVE -->
<div id="main-panel" class="position-fixed d-flex flex-column height-full top-0" style="width: 400px; max-width: 100vw;"></div>


    <!-- Appended controls for other plugins -->


<!-- TODO REMOVE -->
<div id="fullscreen-menu" class="position-absolute top-0 left-0 noselect height-full color-shadow-medium" style="display:none; background: var(--color-bg-primary); z-index: 3;"></div>
<div id="fullscreen-loader" class="position-fixed width-full height-full" style="z-index: 999; background-color: var(--color-bg-backdrop);">
    <div class="loader position-fixed" style="top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
    <div class="position-fixed" style="top: calc(50% + 120px); left: calc(50% + 30px); transform: translate(-50%, -50%); width: 450px; max-width: 85vw;">
        <div id="fullscreen-loader-title" class="h3 text-center" style="display: none"></div>
        <div id="fullscreen-loader-description" class="h4 text-center" style="display: none;"></div>
    </div>
</div>
    <script>
//preventive error message, that will be discarded after the full initialization, no translation
window.onerror = function (message, file, line, col, error) {
    let ErrUI = USER_INTERFACE.Errors;
    if (ErrUI.active) return false;
    error = error || {};
    ErrUI.show("Unknown error.", `Something has gone wrong: '${message}' <br><code>${error.message}
<b>in</b> ${file}, <b>line</b> ${line}</code>`, true);
    return false;
};
    </script>

    <!-- Template app -->
    <template id="template-app"></template>

    <!-- Template modules -->
    <template id="template-modules"></template>

    <script type="text/javascript">

(function (window) {

    /*---------------------------------------------------------*/
    /*------------ Basic Tutorial       -----------------------*/
    /*---------------------------------------------------------*/

    const withLayers = () => APPLICATION_CONTEXT.layersAvailable;
    window.USER_INTERFACE.Tutorials.add("", $.t('tutorials.basic.title'), $.t('tutorials.basic.description'), "foundation", [
        {'next #viewer-container' : $.t('tutorials.basic.1')
        }, {'next #main-panel' : $.t('tutorials.basic.2')
        }, {'next #navigator-container' : $.t('tutorials.basic.3')
        }, {'next #navigator-container' : $.t('tutorials.basic.4'),
            runIf: function() {return APPLICATION_CONTEXT.config.background.length === 1 && withLayers();}
        }, {'next #tissue-title-header' : $.t('tutorials.basic.4a'),
            runIf: function() {return APPLICATION_CONTEXT.config.background.length === 1 && !withLayers();}
        }, {'next #global-opacity' : $.t('tutorials.basic.5'), runIf: withLayers
        }, {
            'next #__tisue_list' : $.t('tutorials.basic.6'),
            runIf: function () {return APPLICATION_CONTEXT.config.background.length > 1 && !APPLICATION_CONTEXT.getOption("stackedBackground");}
        }, {
            'click #images-pin' : $.t('tutorials.basic.7'),
            runIf: function () {return APPLICATION_CONTEXT.config.background.length > 1 && APPLICATION_CONTEXT.getOption("stackedBackground");}
        }, {'next #panel-images' : $.t('tutorials.basic.8'),
            runIf: function () {return APPLICATION_CONTEXT.config.background.length > 1 && APPLICATION_CONTEXT.getOption("stackedBackground");}
        }, {'next #panel-shaders': $.t('tutorials.basic.9'), runIf: withLayers
        }, {'click #shaders-pin': $.t('tutorials.basic.10'), runIf: withLayers
        }, {'next #shaders': $.t('tutorials.basic.11'), runIf: withLayers
        }, {'next #data-layer-options': $.t('tutorials.basic.12'), runIf: withLayers
        }, {'next #cache-snapshot': $.t('tutorials.basic.13'), runIf: withLayers
        }, {'next #copy-url' : $.t('tutorials.basic.14')
        }, {'next #global-help' : $.t('tutorials.basic.15')}], function() {
        if (withLayers()) {
            //prerequisite - pin in default state
            let pin = $("#shaders-pin");
            let container = pin.parents().eq(1).children().eq(1);
            pin.removeClass('pressed');
            container.removeClass('force-visible');
        }
    });

})(window);
    </script>

    <!-- Template plugins -->
    <template id="template-plugins"></template>

<script>
    APPLICATION_CONTEXT.beginApplicationLifecycle(
        APPLICATION_CONTEXT.config.data,
        APPLICATION_CONTEXT.config.background,
        APPLICATION_CONTEXT.config.visualizations
    );
</script>

<script>
    // hiding the user name if left-side-buttons are too small
    window.addEventListener('DOMContentLoaded', () => {
      const leftSideButtons = document.getElementById('left-side-buttons');
      const userName = document.getElementById('user-name');
  
      const observer = new ResizeObserver(entries => {
        for (let entry of entries) {
            const width = entry.contentRect.width;
            if (width < 100) {
                userName.style.display = 'none';
            } else {
                userName.style.display = '';
            }
        }
      });
  
      observer.observe(document.getElementById('left-side-buttons'));
    });
  </script>
</body>
</html>
