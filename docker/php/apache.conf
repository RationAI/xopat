Listen 8000

MinSpareServers 15
KeepAlive Off

# Make container env vars visible to Apache
PassEnv XO_ROOT_PATH
PassEnv XO_STRIP_PREFIX

<VirtualHost *:8000>
    ServerName localhost
    ServerAlias localhost
    DocumentRoot /var/www/html/xopat

    Include /etc/apache2/.env.apache

    RewriteEngine On

    Alias /health /var/www/healthz.txt
    Alias /ready  /var/www/healthz.txt
    Alias /live   /var/www/healthz.txt
    <LocationMatch "^/(health|ready|live)$">
        Require all granted
        Header set Content-Type "text/plain; charset=utf-8"
        Header set Cache-Control "no-store"
    </LocationMatch>

    # Normalize "has prefix?"  (HAS_PREFIX=1 when XO_ROOT_PATH is non-empty and not "/")
    SetEnvIfExpr "-n '%{ENV:XO_ROOT_PATH}' && %{ENV:XO_ROOT_PATH} != '/'" HAS_PREFIX=1

    # --- If request starts with /<prefix>, strip it internally before hitting files/PHP
    <If "%{ENV:HAS_PREFIX} == 1 && tolower('%{ENV:XO_STRIP_PREFIX}') in {'1','true','on','yes'}">
        RewriteCond %{REQUEST_URI} ^%{ENV:XO_ROOT_PATH}(.*)$
        RewriteRule ^ %1 [L,PT]
    </If>

    # Always tell PHP the public mount so it can set cookie paths / build redirects
    <If "%{ENV:HAS_PREFIX} == 1">
        RequestHeader set X-Forwarded-Prefix "%{XO_ROOT_PATH}e"
    </If>

    <Directory "/var/www/html/xopat">
        AllowOverride All
        Satisfy any
        Allow from all
    </Directory>
</VirtualHost>